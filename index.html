<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í¬íŠ¸í´ë¦¬ì˜¤ ëŒ€ì‹œë³´ë“œ</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg:#0a0c10;--surface:#111318;--surface2:#181b22;--border:#1f2330;
  --accent:#00e5a0;--accent3:#ffd166;--accent4:#6baaff;
  --text:#e8eaf0;--text-muted:#5a6070;--text-dim:#8890a0;
  --positive:#00e5a0;--negative:#ff6b6b;
  --font-display:'Syne',sans-serif;--font-mono:'DM Mono',monospace;--font-body:'Noto Sans KR',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:var(--font-body);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(0,229,160,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,160,.02) 1px,transparent 1px);
  background-size:40px 40px}
.container{max-width:1400px;margin:0 auto;padding:24px;position:relative;z-index:1}

/* â”€â”€ Setup Screen â”€â”€ */
#setup-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
.setup-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:40px;max-width:600px;width:100%;animation:popIn .4s ease}
.setup-logo{font-family:var(--font-display);font-size:32px;font-weight:800;margin-bottom:8px}
.setup-logo span{color:var(--accent)}
.setup-sub{font-size:14px;color:var(--text-muted);margin-bottom:32px;line-height:1.6}
.setup-step{display:flex;gap:16px;margin-bottom:20px;padding:16px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)}
.step-num{width:28px;height:28px;border-radius:50%;background:var(--accent);color:#000;font-weight:700;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-family:var(--font-mono)}
.step-text{font-size:13px;line-height:1.7;color:var(--text-dim)}
.step-text strong{color:var(--text);display:block;margin-bottom:2px}
.step-text code{background:var(--bg);padding:2px 6px;border-radius:4px;font-family:var(--font-mono);font-size:11px;color:var(--accent3)}
.url-input-wrap{display:flex;gap:8px;margin-top:24px}
.url-input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 16px;color:var(--text);font-size:13px;font-family:var(--font-mono);outline:none;transition:border-color .2s}
.url-input:focus{border-color:var(--accent)}
.url-input::placeholder{color:var(--text-muted)}

/* â”€â”€ Buttons â”€â”€ */
.btn{padding:10px 20px;border-radius:8px;font-size:13px;font-family:var(--font-body);font-weight:500;cursor:pointer;border:none;transition:all .2s}
.btn-primary{background:var(--accent);color:#000;font-weight:700}
.btn-primary:hover{background:#00ffb3;transform:translateY(-1px)}
.btn-secondary{background:var(--surface2);color:var(--text-dim);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important}

/* â”€â”€ Dashboard â”€â”€ */
#dashboard-screen{display:none}
header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:28px;padding-bottom:24px;
  border-bottom:1px solid var(--border);animation:fadeDown .6s ease both;flex-wrap:wrap;gap:12px}
.header-left h1{font-family:var(--font-display);font-size:28px;font-weight:800;letter-spacing:-.5px}
.header-left h1 span{color:var(--accent)}
.header-left p{font-size:13px;color:var(--text-muted);margin-top:4px;font-family:var(--font-mono)}
.header-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

/* Refresh banner */
#refresh-banner{display:none;align-items:center;gap:8px;padding:8px 14px;
  background:rgba(0,229,160,.07);border:1px solid rgba(0,229,160,.2);border-radius:8px;
  font-size:12px;font-family:var(--font-mono);color:var(--accent)}
#refresh-spinner{animation:spin 1s linear infinite;display:inline-block}

/* Cards */
.summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:22px;
  transition:border-color .2s,transform .2s;animation:fadeUp .6s ease both}
.card:hover{border-color:rgba(0,229,160,.2);transform:translateY(-2px)}
.card-label{font-size:11px;font-family:var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
.card-value{font-family:var(--font-display);font-size:28px;font-weight:700;letter-spacing:-1px}
.card-sub{font-size:12px;color:var(--text-muted);margin-top:6px;font-family:var(--font-mono)}
.card-badge{display:inline-flex;align-items:center;padding:3px 8px;border-radius:20px;font-size:12px;font-family:var(--font-mono);font-weight:500;margin-top:8px}
.badge-positive{background:rgba(0,229,160,.12);color:var(--positive)}
.badge-negative{background:rgba(255,107,107,.12);color:var(--negative)}

/* Charts */
.main-grid{display:grid;grid-template-columns:1fr 340px;gap:20px;margin-bottom:20px}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;animation:fadeUp .7s ease both}
.chart-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.chart-title{font-family:var(--font-display);font-size:16px;font-weight:700}
.tab-group{display:flex;gap:4px;background:var(--surface2);padding:3px;border-radius:8px}
.tab-btn{padding:4px 12px;border-radius:6px;font-size:12px;font-family:var(--font-mono);cursor:pointer;
  color:var(--text-muted);border:none;background:none;transition:all .2s;white-space:nowrap}
.tab-btn.active{background:var(--surface);color:var(--accent);border:1px solid rgba(0,229,160,.2)}

/* Table */
.table-section{animation:fadeUp .8s ease both}
.table-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.table-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.table-title{font-family:var(--font-display);font-size:16px;font-weight:700}
table{width:100%;border-collapse:collapse}
thead th{padding:12px 16px;text-align:right;font-size:11px;font-family:var(--font-mono);
  color:var(--text-muted);text-transform:uppercase;letter-spacing:.8px;
  background:var(--surface2);border-bottom:1px solid var(--border)}
thead th:first-child{text-align:left}
thead th:nth-child(2){text-align:center}
tbody tr{border-bottom:1px solid var(--border);transition:background .15s}
tbody tr:hover{background:var(--surface2)}
tbody tr:last-child{border-bottom:none}
tbody td{padding:14px 16px;font-size:13px;text-align:right;font-family:var(--font-mono)}
tbody td:first-child{text-align:left;font-family:var(--font-body)}
tbody td:nth-child(2){text-align:center}

.ticker-cell{display:flex;align-items:center;gap:12px}
.ticker-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;font-family:var(--font-mono);flex-shrink:0}
.ticker-info .name{font-weight:500;font-size:14px;font-family:var(--font-body)}
.type-badge{display:inline-block;padding:1px 6px;border-radius:4px;font-size:10px;font-family:var(--font-mono);margin-top:2px}
.type-stock{background:rgba(107,170,255,.12);color:var(--accent4)}
.type-etf{background:rgba(255,209,102,.12);color:var(--accent3)}
.team-blue{background:rgba(77,159,255,.15);color:#4d9fff;border:1px solid rgba(77,159,255,.3)}
.team-white{background:rgba(232,234,240,.08);color:#c8ccd8;border:1px solid rgba(232,234,240,.2)}
.val-positive{color:var(--positive)}
.val-negative{color:var(--negative)}

.weight-bar-wrap{display:flex;align-items:center;gap:8px;justify-content:flex-end}
.weight-bar{width:50px;height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.weight-fill{height:100%;border-radius:2px}

/* Donut */
.donut-legend{margin-top:20px;display:flex;flex-direction:column;gap:8px}
.legend-item{display:flex;align-items:center;justify-content:space-between;font-size:13px}
.legend-left{display:flex;align-items:center;gap:8px}
.legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.legend-name{color:var(--text-dim)}
.legend-pct{font-family:var(--font-mono);font-size:12px}

/* Team cards */
.team-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:20px}
.team-card{border-radius:10px;padding:16px}
.team-card.blue{background:rgba(77,159,255,.08);border:1px solid rgba(77,159,255,.2)}
.team-card.white{background:rgba(232,234,240,.05);border:1px solid rgba(232,234,240,.12)}
.team-card-label{font-size:11px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
.team-card.blue .team-card-label{color:#4d9fff}
.team-card.white .team-card-label{color:#c8ccd8}
.team-card-pct{font-family:var(--font-display);font-size:26px;font-weight:700;margin-bottom:6px}
.team-bar-wrap{height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin-bottom:6px}
.team-bar-fill{height:100%;border-radius:3px;transition:width .5s ease}
.team-bar-fill.blue{background:#4d9fff}
.team-bar-fill.white{background:#c8ccd8}
.team-card-sub{font-size:11px;font-family:var(--font-mono);color:var(--text-muted)}

.section-divider{display:flex;align-items:center;gap:12px;margin-bottom:16px;
  font-size:12px;font-family:var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}
.section-divider::after{content:'';flex:1;height:1px;background:var(--border)}

.empty-state{text-align:center;padding:60px 20px;color:var(--text-muted)}

/* Error / info */
.alert{padding:12px 16px;border-radius:10px;font-size:13px;font-family:var(--font-mono);margin-bottom:20px}
.alert-warn{background:rgba(255,209,102,.08);border:1px solid rgba(255,209,102,.2);color:var(--accent3)}
.alert-err{background:rgba(255,107,107,.08);border:1px solid rgba(255,107,107,.2);color:var(--negative)}

@keyframes fadeDown{from{opacity:0;transform:translateY(-16px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes popIn{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.card:nth-child(1){animation-delay:.05s}.card:nth-child(2){animation-delay:.1s}
.card:nth-child(3){animation-delay:.15s}.card:nth-child(4){animation-delay:.2s}
@media(max-width:900px){.summary-grid{grid-template-columns:repeat(2,1fr)}.main-grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETUP SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="setup-screen">
  <div class="setup-card">
    <div class="setup-logo">í¬íŠ¸í´ë¦¬ì˜¤ <span>ëŒ€ì‹œë³´ë“œ</span></div>
    <div class="setup-sub">êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì™€ ì—°ë™í•˜ë©´ í˜„ì¬ê°€ê°€ ìë™ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.<br>ì•„ë˜ ìˆœì„œë¥¼ ë”°ë¼ ì„¤ì •í•´ ì£¼ì„¸ìš”. (ìµœì´ˆ 1íšŒë§Œ)</div>

    <div class="setup-step">
      <div class="step-num">1</div>
      <div class="step-text">
        <strong>êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ë°ì´í„° ì…ë ¥</strong>
        ì œê³µëœ <code>portfolio-sheet.xlsx</code> íŒŒì¼ì„ êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì—…ë¡œë“œí•˜ê±°ë‚˜,
        êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ì§ì ‘ ì¢…ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.<br>
        í˜„ì¬ê°€ ì…€ì— <code>=GOOGLEFINANCE("KRX:005930","price")</code> ìˆ˜ì‹ì„ ì…ë ¥í•˜ë©´ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤.
      </div>
    </div>

    <div class="setup-step">
      <div class="step-num">2</div>
      <div class="step-text">
        <strong>ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì›¹ì— ê²Œì‹œ</strong>
        êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë©”ë‰´ â†’ <code>íŒŒì¼</code> â†’ <code>ì›¹ì— ê²Œì‹œ</code> â†’ ì‹œíŠ¸ ì„ íƒ â†’
        í˜•ì‹ì„ <code>ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ê°’(.csv)</code> ì„ íƒ â†’ <code>ê²Œì‹œ</code> ë²„íŠ¼ í´ë¦­ â†’
        ìƒì„±ëœ URL ë³µì‚¬
      </div>
    </div>

    <div class="setup-step">
      <div class="step-num">3</div>
      <div class="step-text">
        <strong>ì•„ë˜ì— CSV URL ë¶™ì—¬ë„£ê¸°</strong>
        ë³µì‚¬í•œ URLì„ ì•„ë˜ ì…ë ¥ì°½ì— ë¶™ì—¬ë„£ê³  <code>ì—°ê²°í•˜ê¸°</code>ë¥¼ í´ë¦­í•˜ì„¸ìš”.
        URL í˜•ì‹: <code>https://docs.google.com/spreadsheets/d/.../pub?...&output=csv</code>
      </div>
    </div>

    <div class="url-input-wrap">
      <input class="url-input" id="sheet-url" placeholder="êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ CSV URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”â€¦">
      <button class="btn btn-primary" onclick="connectSheet()">ì—°ê²°í•˜ê¸°</button>
    </div>
    <div id="setup-error" style="margin-top:12px;font-size:12px;color:var(--negative);font-family:var(--font-mono);min-height:18px"></div>

    <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);font-size:11px;color:var(--text-muted);font-family:var(--font-mono)">
      ğŸ’¾ URLì€ ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤. ë‹¤ìŒ ì ‘ì† ì‹œ ìë™ìœ¼ë¡œ ì—°ê²°ë¼ìš”.
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="dashboard-screen">
<div class="container">
  <header>
    <div class="header-left">
      <h1>í¬íŠ¸í´ë¦¬ì˜¤ <span>ëŒ€ì‹œë³´ë“œ</span></h1>
      <p id="last-updated">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: --</p>
    </div>
    <div class="header-actions">
      <div id="refresh-banner">
        <span id="refresh-spinner">âŸ³</span>
        <span id="refresh-text">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</span>
      </div>
      <button class="btn btn-secondary" onclick="showSetup()">âš™ ì‹œíŠ¸ ë³€ê²½</button>
      <button class="btn btn-secondary" id="refresh-btn" onclick="loadSheet()">â†» ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </header>

  <div id="alert-area"></div>

  <div class="summary-grid">
    <div class="card">
      <div class="card-label">ì´ í‰ê°€ê¸ˆì•¡</div>
      <div class="card-value" id="total-value">â‚©0</div>
      <div class="card-sub" id="total-invested">íˆ¬ìì›ê¸ˆ: â‚©0</div>
    </div>
    <div class="card">
      <div class="card-label">ì´ ì†ìµ</div>
      <div class="card-value" id="total-pnl">â‚©0</div>
      <div class="card-badge badge-positive" id="total-pnl-pct">0.00%</div>
    </div>
    <div class="card">
      <div class="card-label">ë°°ë‹¹ ìˆ˜ìµë¥  (í‰ê· )</div>
      <div class="card-value" id="avg-dividend">0.00%</div>
      <div class="card-sub" id="annual-dividend">ì—°ê°„ ì˜ˆìƒë°°ë‹¹: â‚©0</div>
    </div>
    <div class="card">
      <div class="card-label">í‰ê·  PER / PBR</div>
      <div class="card-value" id="avg-per">- / -</div>
      <div class="card-sub">ë³´ìœ ì¢…ëª© <span id="stock-count">0</span>ê°œ</div>
    </div>
  </div>

  <div class="main-grid">
    <div class="chart-card">
      <div class="chart-card-header">
        <div class="chart-title">ìˆ˜ìµë¥ </div>
        <div class="tab-group" id="return-tabs">
          <button class="tab-btn active" onclick="switchReturnTab('all',this)">ì „ì²´</button>
          <button class="tab-btn" onclick="switchReturnTab('blue',this)">ì²­íŒ€</button>
          <button class="tab-btn" onclick="switchReturnTab('white',this)">ë°±íŒ€</button>
        </div>
      </div>
      <canvas id="returnChart" height="220"></canvas>
    </div>
    <div class="chart-card">
      <div class="chart-card-header">
        <div class="chart-title">ë¹„ì¤‘ ë¶„ì„</div>
        <div class="tab-group">
          <button class="tab-btn active" id="tab-ticker" onclick="switchDonutTab('ticker')">ì¢…ëª©ë³„</button>
          <button class="tab-btn" id="tab-team" onclick="switchDonutTab('team')">íŒ€ë³„</button>
        </div>
      </div>
      <canvas id="donutChart" height="200"></canvas>
      <div class="donut-legend" id="donut-legend"></div>
      <div class="team-grid" id="team-grid" style="display:none">
        <div class="team-card blue">
          <div class="team-card-label">ğŸ”µ ì²­íŒ€</div>
          <div class="team-card-pct" id="team-blue-pct" style="color:#4d9fff">0%</div>
          <div class="team-bar-wrap"><div class="team-bar-fill blue" id="team-blue-bar" style="width:0%"></div></div>
          <div class="team-card-sub" id="team-blue-sub">â‚©0 Â· 0ì¢…ëª©</div>
        </div>
        <div class="team-card white">
          <div class="team-card-label">âšª ë°±íŒ€</div>
          <div class="team-card-pct" id="team-white-pct" style="color:#c8ccd8">0%</div>
          <div class="team-bar-wrap"><div class="team-bar-fill white" id="team-white-bar" style="width:0%"></div></div>
          <div class="team-card-sub" id="team-white-sub">â‚©0 Â· 0ì¢…ëª©</div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-section">
    <div class="section-divider">ë³´ìœ  ì¢…ëª©</div>
    <div class="table-card">
      <div class="table-header">
        <div class="table-title">ì¢…ëª© ëª©ë¡</div>
        <span style="font-size:12px;color:var(--text-muted);font-family:var(--font-mono)" id="holding-count">0ì¢…ëª©</span>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr>
            <th style="text-align:left">ì¢…ëª©</th>
            <th style="text-align:center">íŒ€</th>
            <th>ë§¤ìˆ˜ê°€</th><th>í˜„ì¬ê°€</th><th>ìˆ˜ëŸ‰</th>
            <th>í‰ê°€ê¸ˆì•¡</th><th>ì†ìµ</th><th>ìˆ˜ìµë¥ </th>
            <th>PER</th><th>PBR</th><th>ë°°ë‹¹ë¥ </th><th>ë¹„ì¤‘</th>
          </tr></thead>
          <tbody id="holdings-tbody">
            <tr><td colspan="12"><div class="empty-state">ğŸ“Š ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì—°ê²°í•´ ì£¼ì„¸ìš”</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
</div>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let holdings = [];
let donutMode = 'ticker';
let returnTab = 'all';
const STORAGE_KEY = 'portfolio_sheet_url';
const PALETTE = ['#00e5a0','#6baaff','#ffd166','#ff6b6b','#c77dff','#ff9f43','#00d2d3','#ff6ce7','#54a0ff','#5f27cd'];

// â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let returnChart, donutChart;
function initCharts() {
  const TT = {backgroundColor:'#111318',borderColor:'#1f2330',borderWidth:1,
    titleFont:{family:'DM Mono',size:12},bodyFont:{family:'DM Mono',size:12},padding:12};
  returnChart = new Chart(document.getElementById('returnChart'), {
    type:'bar', data:{labels:[],datasets:[{data:[],backgroundColor:[],borderRadius:6}]},
    options:{responsive:true,
      plugins:{legend:{display:false},tooltip:{...TT,callbacks:{label:c=>` ${c.raw.toFixed(2)}%`}}},
      scales:{x:{grid:{color:'#1f2330'},ticks:{color:'#5a6070',font:{family:'DM Mono',size:11}}},
              y:{grid:{color:'#1f2330'},ticks:{color:'#5a6070',font:{family:'DM Mono',size:11},callback:v=>v.toFixed(1)+'%'}}}}
  });
  donutChart = new Chart(document.getElementById('donutChart'), {
    type:'doughnut', data:{labels:[],datasets:[{data:[],backgroundColor:[],borderWidth:0,hoverOffset:6}]},
    options:{cutout:'65%',
      plugins:{legend:{display:false},tooltip:{...TT,callbacks:{label:c=>` ${c.label}: ${c.raw.toFixed(1)}%`}}}}
  });
}

// â”€â”€ FORMAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n, cur='KRW') {
  if (isNaN(n) || n === null) return '-';
  if (cur==='USD') return '$'+Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  return 'â‚©'+Math.round(n).toLocaleString('ko-KR');
}

// â”€â”€ SHEET CONNECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectSheet() {
  const url = document.getElementById('sheet-url').value.trim();
  const errEl = document.getElementById('setup-error');
  if (!url) { errEl.textContent = 'âš  URLì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; return; }
  if (!url.includes('docs.google.com')) { errEl.textContent = 'âš  êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URLì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; return; }
  if (!url.includes('output=csv') && !url.includes('/pub')) {
    errEl.textContent = 'âš  "ì›¹ì— ê²Œì‹œ" í›„ ìƒì„±ëœ CSV URLì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; return;
  }
  errEl.textContent = '';
  localStorage.setItem(STORAGE_KEY, url);
  showDashboard();
  loadSheet();
}

function showSetup() {
  document.getElementById('setup-screen').style.display = 'flex';
  document.getElementById('dashboard-screen').style.display = 'none';
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) document.getElementById('sheet-url').value = saved;
}

function showDashboard() {
  document.getElementById('setup-screen').style.display = 'none';
  document.getElementById('dashboard-screen').style.display = 'block';
}

// â”€â”€ LOAD CSV FROM GOOGLE SHEETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSheet() {
  const url = localStorage.getItem(STORAGE_KEY);
  if (!url) { showSetup(); return; }

  const banner = document.getElementById('refresh-banner');
  const btn = document.getElementById('refresh-btn');
  const spinner = document.getElementById('refresh-spinner');
  banner.style.display = 'flex';
  btn.disabled = true;
  spinner.style.animation = 'spin 1s linear infinite';

  try {
    // ìºì‹œ ë°©ì§€ìš© íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
    const fetchUrl = url + (url.includes('?') ? '&' : '?') + '_t=' + Date.now();
    const res = await fetch(fetchUrl);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const csv = await res.text();
    parseCSV(csv);
    setAlert('', '');
  } catch(e) {
    setAlert('error', `âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${e.message} â€” ìŠ¤í”„ë ˆë“œì‹œíŠ¸ê°€ "ì›¹ì— ê²Œì‹œ" ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.`);
    console.error(e);
  } finally {
    banner.style.display = 'none';
    btn.disabled = false;
    document.getElementById('last-updated').textContent = 'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + new Date().toLocaleString('ko-KR');
  }
}

// â”€â”€ PARSE CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseCSV(csv) {
  const lines = csv.trim().split('\n').map(l => l.split(',').map(c => c.trim().replace(/^"|"$/g,'')));
  // í—¤ë” í–‰ ì°¾ê¸° (í‹°ì»¤ or ticker í¬í•¨í•œ í–‰)
  let headerIdx = lines.findIndex(l => l.some(c => c.toLowerCase().includes('ticker') || c.toLowerCase().includes('í‹°ì»¤')));
  if (headerIdx < 0) headerIdx = 0;
  const headers = lines[headerIdx].map(h => h.toLowerCase());

  // ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘
  const col = (names) => {
    for (const n of names) {
      const idx = headers.findIndex(h => h.includes(n));
      if (idx >= 0) return idx;
    }
    return -1;
  };
  const iTicker   = col(['ticker','í‹°ì»¤']);
  const iName     = col(['name','ì¢…ëª©ëª…']);
  const iType     = col(['type','ìœ í˜•']);
  const iTeam     = col(['team','íŒ€']);
  const iCurrency = col(['currency','í†µí™”']);
  const iBuy      = col(['buy','ë§¤ìˆ˜','í‰ë‹¨ê°€']);
  const iQty      = col(['qty','quantity','ìˆ˜ëŸ‰','ë³´ìœ ']);
  const iCurrent  = col(['current','í˜„ì¬ê°€']);
  const iDividend = col(['dividend','ë°°ë‹¹']);
  const iPer      = col(['per']);
  const iPbr      = col(['pbr']);

  if (iTicker < 0 || iName < 0) {
    setAlert('error', 'âŒ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ í˜•ì‹ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤. í‹°ì»¤(ticker)ì™€ ì¢…ëª©ëª…(name) ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }

  holdings = [];
  for (let i = headerIdx + 1; i < lines.length; i++) {
    const row = lines[i];
    const ticker = row[iTicker];
    if (!ticker || ticker === '') continue;

    const current = iCurrent >= 0 ? parseFloat(row[iCurrent]) : 0;
    const buy     = iBuy >= 0     ? parseFloat(row[iBuy])     : 0;
    const qty     = iQty >= 0     ? parseFloat(row[iQty])     : 0;
    if (isNaN(current) || isNaN(buy) || isNaN(qty)) continue;

    holdings.push({
      ticker,
      name:     iName >= 0     ? row[iName]     : ticker,
      type:     iType >= 0     ? row[iType]      : 'ì£¼ì‹',
      team:     iTeam >= 0     ? row[iTeam]      : '',
      currency: iCurrency >= 0 ? row[iCurrency]  : 'KRW',
      buy, qty, current,
      dividend: iDividend >= 0 ? parseFloat(row[iDividend]) || 0 : 0,
      per:      iPer >= 0      ? row[iPer]        : '',
      pbr:      iPbr >= 0      ? row[iPbr]        : '',
    });
  }

  if (holdings.length === 0) {
    setAlert('warn', 'âš  ì¢…ëª© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ë°ì´í„°ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
  }
  render();
}

function setAlert(type, msg) {
  const el = document.getElementById('alert-area');
  if (!msg) { el.innerHTML = ''; return; }
  el.innerHTML = `<div class="alert alert-${type === 'error' ? 'err' : 'warn'}">${msg}</div>`;
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const tbody = document.getElementById('holdings-tbody');
  if (holdings.length === 0) {
    tbody.innerHTML = `<tr><td colspan="12"><div class="empty-state">ğŸ“Š ì¢…ëª© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div></td></tr>`;
    updateSummary(0); updateCharts(0); return;
  }

  const totalValue = holdings.reduce((s,h) => s + h.current * h.qty, 0);
  tbody.innerHTML = '';

  holdings.forEach((h, i) => {
    const cost  = h.buy * h.qty;
    const value = h.current * h.qty;
    const pnl   = value - cost;
    const pct   = cost > 0 ? (pnl / cost * 100) : 0;
    const weight = totalValue > 0 ? (value / totalValue * 100) : 0;
    const isPos  = pct >= 0;
    const color  = PALETTE[i % PALETTE.length];
    const typeClass = h.type === 'ETF' ? 'type-etf' : 'type-stock';
    const teamBadge = h.team === 'ì²­íŒ€'
      ? `<span class="type-badge team-blue">ì²­íŒ€</span>`
      : h.team === 'ë°±íŒ€'
      ? `<span class="type-badge team-white">ë°±íŒ€</span>`
      : `<span style="color:var(--text-muted);font-size:11px">-</span>`;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><div class="ticker-cell">
        <div class="ticker-icon" style="background:${color}22;color:${color}">${h.ticker.slice(0,4)}</div>
        <div class="ticker-info">
          <div class="name">${h.name}</div>
          <span class="type-badge ${typeClass}">${h.type} Â· ${h.currency}</span>
        </div>
      </div></td>
      <td style="text-align:center">${teamBadge}</td>
      <td>${fmt(h.buy, h.currency)}</td>
      <td>${fmt(h.current, h.currency)}</td>
      <td>${Number(h.qty).toLocaleString()}ì£¼</td>
      <td>${fmt(value, h.currency)}</td>
      <td class="${isPos?'val-positive':'val-negative'}">${isPos?'+':''}${fmt(pnl, h.currency)}</td>
      <td class="${isPos?'val-positive':'val-negative'}">${isPos?'+':''}${pct.toFixed(2)}%</td>
      <td>${h.per || '-'}</td>
      <td>${h.pbr || '-'}</td>
      <td>${h.dividend ? h.dividend + '%' : '-'}</td>
      <td><div class="weight-bar-wrap">
        ${weight.toFixed(1)}%
        <div class="weight-bar"><div class="weight-fill" style="width:${Math.min(weight,100)}%;background:${color}"></div></div>
      </div></td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('holding-count').textContent = holdings.length + 'ì¢…ëª©';
  updateSummary(totalValue);
  updateCharts(totalValue);
}

function updateSummary(totalValue) {
  const totalCost = holdings.reduce((s,h) => s + h.buy * h.qty, 0);
  const pnl = totalValue - totalCost;
  const pnlPct = totalCost > 0 ? (pnl / totalCost * 100) : 0;
  const isPos = pnl >= 0;

  document.getElementById('total-value').textContent = fmt(totalValue);
  document.getElementById('total-invested').textContent = 'íˆ¬ìì›ê¸ˆ: ' + fmt(totalCost);
  document.getElementById('total-pnl').textContent = (isPos?'+':'') + fmt(Math.abs(pnl));
  document.getElementById('total-pnl').style.color = isPos ? 'var(--positive)' : 'var(--negative)';
  const badge = document.getElementById('total-pnl-pct');
  badge.textContent = (isPos?'+':'') + pnlPct.toFixed(2) + '%';
  badge.className = 'card-badge ' + (isPos ? 'badge-positive' : 'badge-negative');

  const annualDiv = holdings.reduce((s,h) => s + h.current*h.qty*(h.dividend||0)/100, 0);
  const avgDiv = totalValue > 0 ? annualDiv/totalValue*100 : 0;
  document.getElementById('avg-dividend').textContent = avgDiv.toFixed(2) + '%';
  document.getElementById('annual-dividend').textContent = 'ì—°ê°„ ì˜ˆìƒë°°ë‹¹: ' + fmt(annualDiv);

  const withPer = holdings.filter(h => h.per && !isNaN(parseFloat(h.per)));
  const withPbr = holdings.filter(h => h.pbr && !isNaN(parseFloat(h.pbr)));
  const avgPer = withPer.length > 0 ? (withPer.reduce((s,h)=>s+parseFloat(h.per),0)/withPer.length).toFixed(1) : '-';
  const avgPbr = withPbr.length > 0 ? (withPbr.reduce((s,h)=>s+parseFloat(h.pbr),0)/withPbr.length).toFixed(2) : '-';
  document.getElementById('avg-per').textContent = avgPer + ' / ' + avgPbr;
  document.getElementById('stock-count').textContent = holdings.length;
}

function switchReturnTab(tab, btn) {
  returnTab = tab;
  document.querySelectorAll('#return-tabs .tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  updateCharts(holdings.reduce((s,h)=>s+h.current*h.qty,0));
}

function switchDonutTab(mode) {
  donutMode = mode;
  document.getElementById('tab-ticker').classList.toggle('active', mode==='ticker');
  document.getElementById('tab-team').classList.toggle('active', mode==='team');
  updateCharts(holdings.reduce((s,h)=>s+h.current*h.qty,0));
}

function updateCharts(totalValue) {
  let filtered = holdings;
  if (returnTab==='blue')  filtered = holdings.filter(h=>h.team==='ì²­íŒ€');
  if (returnTab==='white') filtered = holdings.filter(h=>h.team==='ë°±íŒ€');

  returnChart.data.labels = filtered.map(h=>h.name);
  returnChart.data.datasets[0].data = filtered.map(h=>h.buy>0?(h.current-h.buy)/h.buy*100:0);
  returnChart.data.datasets[0].backgroundColor = returnChart.data.datasets[0].data.map(r=>r>=0?'rgba(0,229,160,.75)':'rgba(255,107,107,.75)');
  returnChart.update('active');

  if (donutMode === 'ticker') {
    document.getElementById('donut-legend').style.display = '';
    document.getElementById('team-grid').style.display = 'none';
    const weights = holdings.map(h=>totalValue>0?h.current*h.qty/totalValue*100:0);
    const colors  = holdings.map((_,i)=>PALETTE[i%PALETTE.length]);
    donutChart.data.labels = holdings.map(h=>h.name);
    donutChart.data.datasets[0].data = weights;
    donutChart.data.datasets[0].backgroundColor = colors;
    donutChart.update('active');
    document.getElementById('donut-legend').innerHTML = holdings.map((h,i)=>`
      <div class="legend-item">
        <div class="legend-left"><div class="legend-dot" style="background:${colors[i]}"></div><span class="legend-name">${h.name}</span></div>
        <span class="legend-pct" style="color:${colors[i]}">${weights[i].toFixed(1)}%</span>
      </div>`).join('');
  } else {
    document.getElementById('donut-legend').style.display = 'none';
    document.getElementById('team-grid').style.display = 'grid';
    const blueVal  = holdings.filter(h=>h.team==='ì²­íŒ€').reduce((s,h)=>s+h.current*h.qty,0);
    const whiteVal = holdings.filter(h=>h.team==='ë°±íŒ€').reduce((s,h)=>s+h.current*h.qty,0);
    const noneVal  = totalValue - blueVal - whiteVal;
    const tL=[],tD=[],tC=[];
    if (blueVal>0)  { tL.push('ì²­íŒ€'); tD.push(totalValue>0?blueVal/totalValue*100:0);  tC.push('#4d9fff'); }
    if (whiteVal>0) { tL.push('ë°±íŒ€'); tD.push(totalValue>0?whiteVal/totalValue*100:0); tC.push('#c8ccd8'); }
    if (noneVal>0)  { tL.push('ë¯¸ì§€ì •'); tD.push(totalValue>0?noneVal/totalValue*100:0); tC.push('#2a2f3d'); }
    donutChart.data.labels = tL;
    donutChart.data.datasets[0].data = tD;
    donutChart.data.datasets[0].backgroundColor = tC;
    donutChart.update('active');
    const bp = totalValue>0?blueVal/totalValue*100:0;
    const wp = totalValue>0?whiteVal/totalValue*100:0;
    document.getElementById('team-blue-pct').textContent  = bp.toFixed(1)+'%';
    document.getElementById('team-blue-bar').style.width  = bp+'%';
    document.getElementById('team-blue-sub').textContent  = fmt(blueVal)+' Â· '+holdings.filter(h=>h.team==='ì²­íŒ€').length+'ì¢…ëª©';
    document.getElementById('team-white-pct').textContent = wp.toFixed(1)+'%';
    document.getElementById('team-white-bar').style.width = wp+'%';
    document.getElementById('team-white-sub').textContent = fmt(whiteVal)+' Â· '+holdings.filter(h=>h.team==='ë°±íŒ€').length+'ì¢…ëª©';
  }
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initCharts();
const savedUrl = localStorage.getItem(STORAGE_KEY);
if (savedUrl) {
  document.getElementById('sheet-url').value = savedUrl;
  showDashboard();
  loadSheet();
} else {
  document.getElementById('setup-screen').style.display = 'flex';
}
</script>
</body>
</html>
