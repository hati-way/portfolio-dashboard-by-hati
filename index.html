<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í¬íŠ¸í´ë¦¬ì˜¤ ëŒ€ì‹œë³´ë“œ</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg:#0a0c10;--surface:#111318;--surface2:#181b22;--border:#1f2330;
  --accent:#00e5a0;--accent3:#ffd166;--accent4:#6baaff;
  --text:#e8eaf0;--text-muted:#5a6070;--text-dim:#8890a0;
  --positive:#00e5a0;--negative:#ff6b6b;
  --font-display:'Syne',sans-serif;--font-mono:'DM Mono',monospace;--font-body:'Noto Sans KR',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:var(--font-body);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(0,229,160,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,160,.02) 1px,transparent 1px);
  background-size:40px 40px}
.container{max-width:1400px;margin:0 auto;padding:24px;position:relative;z-index:1}

header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:32px;padding-bottom:24px;
  border-bottom:1px solid var(--border);animation:fadeDown .6s ease both;flex-wrap:wrap;gap:12px}
.header-left h1{font-family:var(--font-display);font-size:28px;font-weight:800;letter-spacing:-.5px}
.header-left h1 span{color:var(--accent)}
.header-left p{font-size:13px;color:var(--text-muted);margin-top:4px;font-family:var(--font-mono)}
.header-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

.btn{padding:9px 18px;border-radius:8px;font-size:13px;font-family:var(--font-body);font-weight:500;cursor:pointer;border:none;transition:all .2s}
.btn-primary{background:var(--accent);color:#000}
.btn-primary:hover{background:#00ffb3;transform:translateY(-1px)}
.btn-secondary{background:var(--surface2);color:var(--text-dim);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important}

#refresh-banner{display:none;align-items:center;gap:8px;padding:8px 14px;
  background:rgba(0,229,160,.07);border:1px solid rgba(0,229,160,.2);border-radius:8px;
  font-size:12px;font-family:var(--font-mono);color:var(--accent)}
#refresh-spinner{display:inline-block;animation:spin 1s linear infinite}

.summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:22px;
  transition:border-color .2s,transform .2s;animation:fadeUp .6s ease both}
.card:hover{border-color:rgba(0,229,160,.2);transform:translateY(-2px)}
.card-label{font-size:11px;font-family:var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
.card-value{font-family:var(--font-display);font-size:28px;font-weight:700;letter-spacing:-1px}
.card-sub{font-size:12px;color:var(--text-muted);margin-top:6px;font-family:var(--font-mono)}
.card-badge{display:inline-flex;align-items:center;padding:3px 8px;border-radius:20px;
  font-size:12px;font-family:var(--font-mono);font-weight:500;margin-top:8px}
.badge-positive{background:rgba(0,229,160,.12);color:var(--positive)}
.badge-negative{background:rgba(255,107,107,.12);color:var(--negative)}

.main-grid{display:grid;grid-template-columns:1fr 340px;gap:20px;margin-bottom:20px}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;animation:fadeUp .7s ease both}
.chart-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.chart-title{font-family:var(--font-display);font-size:16px;font-weight:700}

.tab-group{display:flex;gap:4px;background:var(--surface2);padding:3px;border-radius:8px}
.tab-btn{padding:4px 12px;border-radius:6px;font-size:12px;font-family:var(--font-mono);cursor:pointer;
  color:var(--text-muted);border:none;background:none;transition:all .2s;white-space:nowrap}
.tab-btn.active{background:var(--surface);color:var(--accent);border:1px solid rgba(0,229,160,.2)}

.table-section{animation:fadeUp .8s ease both}
.table-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.table-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.table-title{font-family:var(--font-display);font-size:16px;font-weight:700}
table{width:100%;border-collapse:collapse}
thead th{padding:12px 16px;text-align:right;font-size:11px;font-family:var(--font-mono);
  color:var(--text-muted);text-transform:uppercase;letter-spacing:.8px;
  background:var(--surface2);border-bottom:1px solid var(--border)}
thead th:first-child{text-align:left}
thead th:nth-child(2){text-align:center}
tbody tr{border-bottom:1px solid var(--border);transition:background .15s;animation:fadeIn .5s ease both}
tbody tr:hover{background:var(--surface2)}
tbody tr:last-child{border-bottom:none}
tbody td{padding:14px 16px;font-size:14px;text-align:right;font-family:var(--font-mono);font-size:13px}
tbody td:first-child{text-align:left;font-family:var(--font-body)}
tbody td:nth-child(2){text-align:center}

.ticker-cell{display:flex;align-items:center;gap:12px}
.ticker-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;font-family:var(--font-mono);flex-shrink:0}
.ticker-info .name{font-weight:500;font-size:14px;font-family:var(--font-body)}
.type-badge{display:inline-block;padding:1px 6px;border-radius:4px;font-size:10px;font-family:var(--font-mono);margin-top:2px}
.type-stock{background:rgba(107,170,255,.12);color:var(--accent4)}
.type-etf{background:rgba(255,209,102,.12);color:var(--accent3)}
.team-blue-badge{background:rgba(77,159,255,.15);color:#4d9fff;border:1px solid rgba(77,159,255,.3)}
.team-white-badge{background:rgba(232,234,240,.08);color:#c8ccd8;border:1px solid rgba(232,234,240,.2)}

.val-positive{color:var(--positive)}
.val-negative{color:var(--negative)}
.val-cell{font-weight:500}

.weight-bar-wrap{display:flex;align-items:center;gap:8px;justify-content:flex-end}
.weight-bar{width:50px;height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.weight-fill{height:100%;border-radius:2px}

.action-btn{background:none;border:none;cursor:pointer;padding:4px 5px;border-radius:4px;font-size:14px;transition:all .2s;line-height:1}
.action-btn:hover{background:var(--surface2)}

.donut-legend{margin-top:20px;display:flex;flex-direction:column;gap:8px}
.legend-item{display:flex;align-items:center;justify-content:space-between;font-size:13px}
.legend-left{display:flex;align-items:center;gap:8px}
.legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.legend-name{color:var(--text-dim)}
.legend-pct{font-family:var(--font-mono);font-size:12px}

.team-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:20px}
.team-card{border-radius:10px;padding:16px;display:flex;flex-direction:column;gap:6px}
.team-card.blue{background:rgba(77,159,255,.08);border:1px solid rgba(77,159,255,.2)}
.team-card.white{background:rgba(232,234,240,.05);border:1px solid rgba(232,234,240,.12)}
.team-card-label{font-size:11px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:.8px}
.team-card.blue .team-card-label{color:#4d9fff}
.team-card.white .team-card-label{color:#c8ccd8}
.team-card-pct{font-family:var(--font-display);font-size:26px;font-weight:700}
.team-bar-wrap{height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin-top:4px}
.team-bar-fill{height:100%;border-radius:3px;transition:width .5s ease}
.team-bar-fill.blue{background:#4d9fff}
.team-bar-fill.white{background:#c8ccd8}
.team-card-sub{font-size:11px;font-family:var(--font-mono);color:var(--text-muted);margin-top:2px}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;
  backdrop-filter:blur(4px);align-items:center;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:28px;
  width:500px;max-width:95vw;max-height:90vh;overflow-y:auto;animation:popIn .3s ease}
.modal-title{font-family:var(--font-display);font-size:20px;font-weight:700;margin-bottom:20px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.form-group{display:flex;flex-direction:column;gap:6px}
.form-label{font-size:11px;font-family:var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:.8px}
.form-input,.form-select{background:var(--surface2);border:1px solid var(--border);border-radius:8px;
  padding:10px 12px;color:var(--text);font-size:14px;font-family:var(--font-body);transition:border-color .2s;outline:none;width:100%}
.form-input:focus,.form-select:focus{border-color:var(--accent)}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px}
.divider{display:flex;align-items:center;gap:10px;margin:16px 0}
.divider-line{flex:1;height:1px;background:var(--border)}
.divider-text{font-size:11px;font-family:var(--font-mono);color:var(--text-muted)}

.section-divider{display:flex;align-items:center;gap:12px;margin-bottom:16px;
  font-size:12px;font-family:var(--font-mono);color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}
.section-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-muted)}
.empty-state p{font-size:14px;margin-top:8px}

@keyframes fadeDown{from{opacity:0;transform:translateY(-16px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes popIn{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

.card:nth-child(1){animation-delay:.05s}.card:nth-child(2){animation-delay:.1s}
.card:nth-child(3){animation-delay:.15s}.card:nth-child(4){animation-delay:.2s}
@media(max-width:900px){.summary-grid{grid-template-columns:repeat(2,1fr)}.main-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">

  <header>
    <div class="header-left">
      <h1>í¬íŠ¸í´ë¦¬ì˜¤ <span>ëŒ€ì‹œë³´ë“œ</span></h1>
      <p id="last-updated">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: --</p>
    </div>
    <div class="header-actions">
      <div id="refresh-banner">
        <span id="refresh-spinner">âŸ³</span>
        <span id="refresh-text">ì‹œì„¸ ì—…ë°ì´íŠ¸ ì¤‘â€¦</span>
      </div>
      <button class="btn btn-secondary" onclick="clearAll()">ì´ˆê¸°í™”</button>
      <button class="btn btn-secondary" id="refresh-all-btn" onclick="refreshAllHoldings()">â†» ì „ì²´ ìƒˆë¡œê³ ì¹¨</button>
      <button class="btn btn-primary" onclick="openModal()">+ ì¢…ëª© ì¶”ê°€</button>
    </div>
  </header>

  <div class="summary-grid">
    <div class="card">
      <div class="card-label">ì´ í‰ê°€ê¸ˆì•¡</div>
      <div class="card-value" id="total-value">â‚©0</div>
      <div class="card-sub" id="total-invested">íˆ¬ìì›ê¸ˆ: â‚©0</div>
    </div>
    <div class="card">
      <div class="card-label">ì´ ì†ìµ</div>
      <div class="card-value" id="total-pnl">â‚©0</div>
      <div class="card-badge badge-positive" id="total-pnl-pct">0.00%</div>
    </div>
    <div class="card">
      <div class="card-label">ë°°ë‹¹ ìˆ˜ìµë¥  (í‰ê· )</div>
      <div class="card-value" id="avg-dividend">0.00%</div>
      <div class="card-sub" id="annual-dividend">ì—°ê°„ ì˜ˆìƒë°°ë‹¹: â‚©0</div>
    </div>
    <div class="card">
      <div class="card-label">í‰ê·  PER / PBR</div>
      <div class="card-value" id="avg-per">- / -</div>
      <div class="card-sub">ë³´ìœ ì¢…ëª© <span id="stock-count">0</span>ê°œ</div>
    </div>
  </div>

  <div class="main-grid">
    <div class="chart-card">
      <div class="chart-card-header">
        <div class="chart-title">ìˆ˜ìµë¥ </div>
        <div class="tab-group" id="return-tabs">
          <button class="tab-btn active" onclick="switchReturnTab('all',this)">ì „ì²´</button>
          <button class="tab-btn" onclick="switchReturnTab('blue',this)">ì²­íŒ€</button>
          <button class="tab-btn" onclick="switchReturnTab('white',this)">ë°±íŒ€</button>
        </div>
      </div>
      <canvas id="returnChart" height="220"></canvas>
    </div>

    <div class="chart-card">
      <div class="chart-card-header">
        <div class="chart-title">ë¹„ì¤‘ ë¶„ì„</div>
        <div class="tab-group">
          <button class="tab-btn active" id="tab-ticker" onclick="switchDonutTab('ticker')">ì¢…ëª©ë³„</button>
          <button class="tab-btn" id="tab-team" onclick="switchDonutTab('team')">íŒ€ë³„</button>
        </div>
      </div>
      <canvas id="donutChart" height="200"></canvas>
      <div class="donut-legend" id="donut-legend"></div>
      <div class="team-grid" id="team-grid" style="display:none">
        <div class="team-card blue">
          <div class="team-card-label">ğŸ”µ ì²­íŒ€</div>
          <div class="team-card-pct" id="team-blue-pct" style="color:#4d9fff">0%</div>
          <div class="team-bar-wrap"><div class="team-bar-fill blue" id="team-blue-bar" style="width:0%"></div></div>
          <div class="team-card-sub" id="team-blue-sub">â‚©0 Â· 0ì¢…ëª©</div>
        </div>
        <div class="team-card white">
          <div class="team-card-label">âšª ë°±íŒ€</div>
          <div class="team-card-pct" id="team-white-pct" style="color:#c8ccd8">0%</div>
          <div class="team-bar-wrap"><div class="team-bar-fill white" id="team-white-bar" style="width:0%"></div></div>
          <div class="team-card-sub" id="team-white-sub">â‚©0 Â· 0ì¢…ëª©</div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-section">
    <div class="section-divider">ë³´ìœ  ì¢…ëª©</div>
    <div class="table-card">
      <div class="table-header">
        <div class="table-title">ì¢…ëª© ëª©ë¡</div>
        <span style="font-size:12px;color:var(--text-muted);font-family:var(--font-mono)" id="holding-count">0ì¢…ëª©</span>
      </div>
      <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th style="text-align:left">ì¢…ëª©</th>
            <th style="text-align:center">íŒ€</th>
            <th>ë§¤ìˆ˜ê°€</th>
            <th>í˜„ì¬ê°€</th>
            <th>ìˆ˜ëŸ‰</th>
            <th>í‰ê°€ê¸ˆì•¡</th>
            <th>ì†ìµ</th>
            <th>ìˆ˜ìµë¥ </th>
            <th>PER</th>
            <th>PBR</th>
            <th>ë°°ë‹¹ë¥ </th>
            <th>ë¹„ì¤‘</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="holdings-tbody">
          <tr><td colspan="13" style="text-align:center"><div class="empty-state"><div style="font-size:32px">ğŸ“Š</div><p>ì¢…ëª©ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”</p></div></td></tr>
        </tbody>
      </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-title" id="modal-title">ì¢…ëª© ì¶”ê°€</div>
    <div id="ai-fetch-area" style="margin-bottom:18px">
      <div style="display:flex;gap:8px;align-items:center">
        <input class="form-input" id="f-ticker-search" placeholder="í•´ì™¸ì£¼ì‹Â·ETF í‹°ì»¤ ì…ë ¥ í›„ ì‹œì„¸ ì¡°íšŒ (ì˜ˆ: AAPL, QQQ)" style="flex:1">
        <button class="btn btn-primary" id="ai-fetch-btn" onclick="fetchWithAI()" style="white-space:nowrap;padding:10px 14px">ğŸ” ì‹œì„¸ ì¡°íšŒ</button>
      </div>
      <div id="ai-status" style="margin-top:8px;font-size:12px;font-family:var(--font-mono);color:var(--text-muted);min-height:18px"></div>
    </div>
    <div class="divider"><div class="divider-line"></div><span class="divider-text">ì§ì ‘ ì…ë ¥</span><div class="divider-line"></div></div>
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label">í‹°ì»¤/ì¢…ëª©ì½”ë“œ</label>
        <input class="form-input" id="f-ticker" placeholder="005930, AAPL">
      </div>
      <div class="form-group">
        <label class="form-label">ì¢…ëª©ëª…</label>
        <input class="form-input" id="f-name" placeholder="ì‚¼ì„±ì „ì">
      </div>
      <div class="form-group">
        <label class="form-label">ìœ í˜•</label>
        <select class="form-select" id="f-type">
          <option value="êµ­ë‚´ì£¼ì‹">êµ­ë‚´ì£¼ì‹</option>
          <option value="í•´ì™¸ì£¼ì‹">í•´ì™¸ì£¼ì‹</option>
          <option value="ETF">ETF</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">íŒ€</label>
        <select class="form-select" id="f-team">
          <option value="">ë¯¸ì§€ì •</option>
          <option value="ì²­íŒ€">ì²­íŒ€</option>
          <option value="ë°±íŒ€">ë°±íŒ€</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">í†µí™”</label>
        <select class="form-select" id="f-currency">
          <option value="KRW">KRW (ì›)</option>
          <option value="USD">USD (ë‹¬ëŸ¬)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ë§¤ìˆ˜ê°€</label>
        <input class="form-input" id="f-buy" type="number" placeholder="0">
      </div>
      <div class="form-group">
        <label class="form-label">í˜„ì¬ê°€</label>
        <input class="form-input" id="f-current" type="number" placeholder="0">
      </div>
      <div class="form-group">
        <label class="form-label">ìˆ˜ëŸ‰ (ì£¼)</label>
        <input class="form-input" id="f-qty" type="number" placeholder="0">
      </div>
      <div class="form-group">
        <label class="form-label">ë°°ë‹¹ ìˆ˜ìµë¥  (%)</label>
        <input class="form-input" id="f-dividend" type="number" step="0.01" placeholder="0.00">
      </div>
      <div class="form-group">
        <label class="form-label">PER</label>
        <input class="form-input" id="f-per" type="number" step="0.1" placeholder="-">
      </div>
      <div class="form-group">
        <label class="form-label">PBR</label>
        <input class="form-input" id="f-pbr" type="number" step="0.01" placeholder="-">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn btn-primary" id="modal-submit-btn" onclick="saveHolding()">ì¶”ê°€</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let holdings = [];
let donutMode = 'ticker';
let returnTab = 'all';
let editingIndex = -1;

const STORAGE_KEY = 'portfolio_v2';
const PALETTE = ['#00e5a0','#6baaff','#ffd166','#ff6b6b','#c77dff','#ff9f43','#00d2d3','#ff6ce7','#54a0ff','#5f27cd'];

// â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveData() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(holdings)); } catch(e) {}
}
function loadData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return null;
}

// â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let returnChart, donutChart;

function initCharts() {
  const TT = {
    backgroundColor:'#111318', borderColor:'#1f2330', borderWidth:1,
    titleFont:{family:'DM Mono',size:12}, bodyFont:{family:'DM Mono',size:12}, padding:12
  };

  returnChart = new Chart(document.getElementById('returnChart'), {
    type: 'bar',
    data: { labels:[], datasets:[{data:[],backgroundColor:[],borderRadius:6}] },
    options: {
      responsive:true,
      plugins:{ legend:{display:false}, tooltip:{...TT, callbacks:{label:c=>` ${c.raw.toFixed(2)}%`}} },
      scales:{
        x:{grid:{color:'#1f2330'}, ticks:{color:'#5a6070',font:{family:'DM Mono',size:11}}},
        y:{grid:{color:'#1f2330'}, ticks:{color:'#5a6070',font:{family:'DM Mono',size:11},callback:v=>v.toFixed(1)+'%'}}
      }
    }
  });

  donutChart = new Chart(document.getElementById('donutChart'), {
    type: 'doughnut',
    data: { labels:[], datasets:[{data:[],backgroundColor:[],borderWidth:0,hoverOffset:6}] },
    options: {
      cutout:'65%',
      plugins:{ legend:{display:false}, tooltip:{...TT, callbacks:{label:c=>` ${c.label}: ${c.raw.toFixed(1)}%`}} }
    }
  });
}

// â”€â”€ FORMAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n, cur='KRW', dec=0) {
  if (cur==='USD') return '$'+Number(n).toLocaleString('en-US',{minimumFractionDigits:dec,maximumFractionDigits:dec});
  return 'â‚©'+Math.round(n).toLocaleString('ko-KR');
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const tbody = document.getElementById('holdings-tbody');

  if (holdings.length === 0) {
    tbody.innerHTML = `<tr><td colspan="13" style="text-align:center"><div class="empty-state"><div style="font-size:32px">ğŸ“Š</div><p>ì¢…ëª©ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”</p></div></td></tr>`;
    updateSummary(0); updateCharts(0); return;
  }

  const totalValue = holdings.reduce((s,h) => s + h.current * h.qty, 0);
  tbody.innerHTML = '';

  holdings.forEach((h, i) => {
    const cost = h.buy * h.qty;
    const value = h.current * h.qty;
    const pnl = value - cost;
    const pct = cost > 0 ? (pnl / cost * 100) : 0;
    const weight = totalValue > 0 ? (value / totalValue * 100) : 0;
    const isPos = pct >= 0;
    const color = PALETTE[i % PALETTE.length];
    const typeClass = h.type === 'ETF' ? 'type-etf' : 'type-stock';
    const teamBadge = h.team === 'ì²­íŒ€'
      ? `<span class="type-badge team-blue-badge">ì²­íŒ€</span>`
      : h.team === 'ë°±íŒ€'
      ? `<span class="type-badge team-white-badge">ë°±íŒ€</span>`
      : `<span style="color:var(--text-muted);font-size:11px;font-family:var(--font-mono)">-</span>`;

    const tr = document.createElement('tr');
    tr.style.animationDelay = (i * 0.04) + 's';
    tr.innerHTML = `
      <td>
        <div class="ticker-cell">
          <div class="ticker-icon" style="background:${color}22;color:${color}">${h.ticker.slice(0,4)}</div>
          <div class="ticker-info">
            <div class="name">${h.name}</div>
            <span class="type-badge ${typeClass}">${h.type} Â· ${h.currency}</span>
          </div>
        </div>
      </td>
      <td style="text-align:center">${teamBadge}</td>
      <td class="val-cell">${fmt(h.buy, h.currency, h.currency==='USD'?2:0)}</td>
      <td class="val-cell">${fmt(h.current, h.currency, h.currency==='USD'?2:0)}</td>
      <td>${Number(h.qty).toLocaleString()}ì£¼</td>
      <td class="val-cell">${fmt(value, h.currency)}</td>
      <td class="${isPos?'val-positive':'val-negative'}">${isPos?'+':''}${fmt(pnl, h.currency)}</td>
      <td class="${isPos?'val-positive':'val-negative'}">${isPos?'+':''}${pct.toFixed(2)}%</td>
      <td>${h.per || '-'}</td>
      <td>${h.pbr || '-'}</td>
      <td>${h.dividend ? h.dividend+'%' : '-'}</td>
      <td>
        <div class="weight-bar-wrap">
          ${weight.toFixed(1)}%
          <div class="weight-bar"><div class="weight-fill" style="width:${Math.min(weight,100)}%;background:${color}"></div></div>
        </div>
      </td>
      <td style="white-space:nowrap">
        <button class="action-btn" onclick="openEditModal(${i})" title="ìˆ˜ì •" style="color:var(--accent3)">âœ</button>
        <button class="action-btn" onclick="refreshOne(${i})" title="AI ìƒˆë¡œê³ ì¹¨" style="color:var(--accent)">â†»</button>
        <button class="action-btn" onclick="deleteHolding(${i})" title="ì‚­ì œ" style="color:var(--negative)">âœ•</button>
      </td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('holding-count').textContent = holdings.length + 'ì¢…ëª©';
  updateSummary(totalValue);
  updateCharts(totalValue);
  document.getElementById('last-updated').textContent = 'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + new Date().toLocaleString('ko-KR');
  saveData();
}

function updateSummary(totalValue) {
  const totalCost = holdings.reduce((s,h) => s + h.buy * h.qty, 0);
  const pnl = totalValue - totalCost;
  const pnlPct = totalCost > 0 ? (pnl / totalCost * 100) : 0;
  const isPos = pnl >= 0;

  document.getElementById('total-value').textContent = 'â‚©' + Math.round(totalValue).toLocaleString('ko-KR');
  document.getElementById('total-invested').textContent = 'íˆ¬ìì›ê¸ˆ: â‚©' + Math.round(totalCost).toLocaleString('ko-KR');
  document.getElementById('total-pnl').textContent = (isPos?'+':'')+'â‚©'+Math.round(Math.abs(pnl)).toLocaleString('ko-KR');
  document.getElementById('total-pnl').style.color = isPos ? 'var(--positive)' : 'var(--negative)';
  const badge = document.getElementById('total-pnl-pct');
  badge.textContent = (isPos?'+':'')+pnlPct.toFixed(2)+'%';
  badge.className = 'card-badge '+(isPos?'badge-positive':'badge-negative');

  const annualDiv = holdings.reduce((s,h) => s + h.current*h.qty*(h.dividend||0)/100, 0);
  const avgDiv = totalValue > 0 ? (annualDiv/totalValue*100) : 0;
  document.getElementById('avg-dividend').textContent = avgDiv.toFixed(2)+'%';
  document.getElementById('annual-dividend').textContent = 'ì—°ê°„ ì˜ˆìƒë°°ë‹¹: â‚©'+Math.round(annualDiv).toLocaleString('ko-KR');

  const withPer = holdings.filter(h => h.per && !isNaN(parseFloat(h.per)));
  const withPbr = holdings.filter(h => h.pbr && !isNaN(parseFloat(h.pbr)));
  const avgPer = withPer.length > 0 ? (withPer.reduce((s,h)=>s+parseFloat(h.per),0)/withPer.length).toFixed(1) : '-';
  const avgPbr = withPbr.length > 0 ? (withPbr.reduce((s,h)=>s+parseFloat(h.pbr),0)/withPbr.length).toFixed(2) : '-';
  document.getElementById('avg-per').textContent = avgPer+' / '+avgPbr;
  document.getElementById('stock-count').textContent = holdings.length;
}

function switchReturnTab(tab, btn) {
  returnTab = tab;
  document.querySelectorAll('#return-tabs .tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const tv = holdings.reduce((s,h)=>s+h.current*h.qty,0);
  updateCharts(tv);
}

function switchDonutTab(mode) {
  donutMode = mode;
  document.getElementById('tab-ticker').classList.toggle('active', mode==='ticker');
  document.getElementById('tab-team').classList.toggle('active', mode==='team');
  const tv = holdings.reduce((s,h)=>s+h.current*h.qty,0);
  updateCharts(tv);
}

function updateCharts(totalValue) {
  // Return chart
  let filtered = holdings;
  if (returnTab==='blue')  filtered = holdings.filter(h=>h.team==='ì²­íŒ€');
  if (returnTab==='white') filtered = holdings.filter(h=>h.team==='ë°±íŒ€');

  returnChart.data.labels = filtered.map(h=>h.name);
  returnChart.data.datasets[0].data = filtered.map(h=>h.buy>0?(h.current-h.buy)/h.buy*100:0);
  returnChart.data.datasets[0].backgroundColor = returnChart.data.datasets[0].data.map(r=>r>=0?'rgba(0,229,160,.75)':'rgba(255,107,107,.75)');
  returnChart.update('active');

  // Donut
  if (donutMode==='ticker') {
    document.getElementById('donut-legend').style.display='';
    document.getElementById('team-grid').style.display='none';

    const weights = holdings.map(h=>totalValue>0?h.current*h.qty/totalValue*100:0);
    const colors  = holdings.map((_,i)=>PALETTE[i%PALETTE.length]);

    donutChart.data.labels = holdings.map(h=>h.name);
    donutChart.data.datasets[0].data = weights;
    donutChart.data.datasets[0].backgroundColor = colors;
    donutChart.update('active');

    document.getElementById('donut-legend').innerHTML = holdings.map((h,i)=>`
      <div class="legend-item">
        <div class="legend-left">
          <div class="legend-dot" style="background:${colors[i]}"></div>
          <span class="legend-name">${h.name}</span>
        </div>
        <span class="legend-pct" style="color:${colors[i]}">${weights[i].toFixed(1)}%</span>
      </div>`).join('');

  } else {
    document.getElementById('donut-legend').style.display='none';
    document.getElementById('team-grid').style.display='grid';

    const blueVal  = holdings.filter(h=>h.team==='ì²­íŒ€').reduce((s,h)=>s+h.current*h.qty,0);
    const whiteVal = holdings.filter(h=>h.team==='ë°±íŒ€').reduce((s,h)=>s+h.current*h.qty,0);
    const noneVal  = totalValue - blueVal - whiteVal;

    const tLabels=[],tData=[],tColors=[];
    if (blueVal>0)  { tLabels.push('ì²­íŒ€'); tData.push(totalValue>0?blueVal/totalValue*100:0);  tColors.push('#4d9fff'); }
    if (whiteVal>0) { tLabels.push('ë°±íŒ€'); tData.push(totalValue>0?whiteVal/totalValue*100:0); tColors.push('#c8ccd8'); }
    if (noneVal>0)  { tLabels.push('ë¯¸ì§€ì •'); tData.push(totalValue>0?noneVal/totalValue*100:0); tColors.push('#2a2f3d'); }

    donutChart.data.labels = tLabels;
    donutChart.data.datasets[0].data = tData;
    donutChart.data.datasets[0].backgroundColor = tColors;
    donutChart.update('active');

    const bp = totalValue>0?blueVal/totalValue*100:0;
    const wp = totalValue>0?whiteVal/totalValue*100:0;
    document.getElementById('team-blue-pct').textContent  = bp.toFixed(1)+'%';
    document.getElementById('team-blue-bar').style.width  = bp+'%';
    document.getElementById('team-blue-sub').textContent  = 'â‚©'+Math.round(blueVal).toLocaleString('ko-KR')+' Â· '+holdings.filter(h=>h.team==='ì²­íŒ€').length+'ì¢…ëª©';
    document.getElementById('team-white-pct').textContent = wp.toFixed(1)+'%';
    document.getElementById('team-white-bar').style.width = wp+'%';
    document.getElementById('team-white-sub').textContent = 'â‚©'+Math.round(whiteVal).toLocaleString('ko-KR')+' Â· '+holdings.filter(h=>h.team==='ë°±íŒ€').length+'ì¢…ëª©';
  }
}

// â”€â”€ ì£¼ê°€ ì¡°íšŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchYahooPrice(ticker) {
  // allorigins.win: ë¬´ë£Œ CORS í”„ë¡ì‹œ
  const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?interval=1d&range=1d`;
  const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(yahooUrl)}`;

  const res = await fetch(proxyUrl);
  if (!res.ok) throw new Error(`í”„ë¡ì‹œ ì˜¤ë¥˜ (${res.status})`);
  const wrapper = await res.json();
  const data = JSON.parse(wrapper.contents);
  const meta = data?.chart?.result?.[0]?.meta;
  if (!meta) throw new Error('ë°ì´í„° ì—†ìŒ');
  return {
    ticker,
    name: meta.shortName || meta.longName || ticker,
    current: meta.regularMarketPrice ?? meta.previousClose ?? null,
    currency: meta.currency ?? 'USD'
  };
}

function isDomestic(type) {
  return type === 'êµ­ë‚´ì£¼ì‹';
}

function setStatus(msg, color='var(--text-muted)') {
  const el = document.getElementById('ai-status');
  if (el) { el.textContent=msg; el.style.color=color; }
}

async function fetchWithAI() {
  const ticker = document.getElementById('f-ticker-search').value.trim().toUpperCase();
  if (!ticker) { setStatus('âš  í‹°ì»¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.','var(--accent3)'); return; }
  const type = document.getElementById('f-type').value;
  const btn = document.getElementById('ai-fetch-btn');

  if (isDomestic(type)) {
    // êµ­ë‚´ì£¼ì‹ì€ ìë™ ì¡°íšŒ ë¶ˆê°€ â†’ í‹°ì»¤ë§Œ ì±„ì›Œì£¼ê³  ì•ˆë‚´
    document.getElementById('f-ticker').value = ticker;
    setStatus('ğŸ“ êµ­ë‚´ì£¼ì‹ì€ í˜„ì¬ê°€ë¥¼ ì§ì ‘ ì…ë ¥í•´ ì£¼ì„¸ìš” (ë„¤ì´ë²„ ê¸ˆìœµ ì°¸ê³ )', 'var(--accent3)');
    return;
  }

  btn.disabled=true; btn.textContent='ì¡°íšŒ ì¤‘â€¦';
  setStatus(`ğŸ” ${ticker} ì‹œì„¸ ì¡°íšŒ ì¤‘â€¦`, 'var(--accent)');
  try {
    const r = await fetchYahooPrice(ticker);
    document.getElementById('f-ticker').value   = ticker;
    if (r.name)    document.getElementById('f-name').value    = r.name;
    if (r.current) document.getElementById('f-current').value = r.current;
    setStatus('âœ… í˜„ì¬ê°€ ì¡°íšŒ ì™„ë£Œ! ìˆ˜ëŸ‰Â·ë§¤ìˆ˜ê°€Â·PERÂ·PBRì€ ì§ì ‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'var(--positive)');
  } catch(e) {
    setStatus('âŒ ì¡°íšŒ ì‹¤íŒ¨ â€” ' + e.message, 'var(--negative)');
    document.getElementById('f-ticker').value = ticker;
    console.error(e);
  } finally {
    btn.disabled=false; btn.textContent='ğŸ” ì‹œì„¸ ì¡°íšŒ';
  }
}

async function refreshOne(i) {
  const h = holdings[i];
  if (isDomestic(h.type)) {
    alert(`'${h.name}'ì€ êµ­ë‚´ì£¼ì‹ì´ë¼ ìë™ ì¡°íšŒê°€ ì•ˆ ë©ë‹ˆë‹¤.\nâœ ìˆ˜ì • ë²„íŠ¼ìœ¼ë¡œ í˜„ì¬ê°€ë¥¼ ì§ì ‘ ì—…ë°ì´íŠ¸í•´ ì£¼ì„¸ìš”.`);
    return;
  }
  const row = document.querySelector(`#holdings-tbody tr:nth-child(${i+1})`);
  if (row) row.style.opacity='0.5';
  try {
    const r = await fetchYahooPrice(h.ticker);
    if (r.current) h.current = r.current;
    render();
  } catch(e) {
    if (row) row.style.opacity='';
    alert('ì‹œì„¸ ì¡°íšŒ ì‹¤íŒ¨: ' + e.message);
    console.error(e);
  }
}

async function refreshAllHoldings() {
  if (holdings.length===0) return;
  const banner  = document.getElementById('refresh-banner');
  const btn     = document.getElementById('refresh-all-btn');
  const spinner = document.getElementById('refresh-spinner');
  const text    = document.getElementById('refresh-text');
  banner.style.display='flex'; btn.disabled=true;
  spinner.style.animation='spin 1s linear infinite'; spinner.textContent='âŸ³'; spinner.style.color='';

  let ok=0, skip=0, fail=0;
  for (let i=0; i<holdings.length; i++) {
    const h = holdings[i];
    text.textContent = `${h.name} ì¡°íšŒ ì¤‘â€¦ (${i+1}/${holdings.length})`;
    if (isDomestic(h.type)) { skip++; continue; } // êµ­ë‚´ì£¼ì‹ ê±´ë„ˆëœ€
    try {
      const r = await fetchYahooPrice(h.ticker);
      if (r.current) h.current = r.current;
      ok++; render();
    } catch(e) { fail++; console.error(h.ticker, e); }
  }

  spinner.style.animation='none';
  spinner.textContent = fail===0 ? 'âœ“' : 'âš ';
  spinner.style.color = fail===0 ? 'var(--positive)' : 'var(--accent3)';
  const msg = [];
  if (ok>0)   msg.push(`${ok}ê°œ ì—…ë°ì´íŠ¸`);
  if (skip>0) msg.push(`${skip}ê°œ ìˆ˜ë™ì…ë ¥ í•„ìš”`);
  if (fail>0) msg.push(`${fail}ê°œ ì‹¤íŒ¨`);
  text.textContent = msg.join(' Â· ');
  setTimeout(()=>{ banner.style.display='none'; btn.disabled=false; }, 3500);
  render();
}


// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal() {
  editingIndex=-1;
  document.getElementById('modal-title').textContent='ì¢…ëª© ì¶”ê°€';
  document.getElementById('modal-submit-btn').textContent='ì¶”ê°€';
  document.getElementById('ai-fetch-area').style.display='';
  document.getElementById('modal').classList.add('active');
}

function openEditModal(i) {
  editingIndex=i;
  const h=holdings[i];
  document.getElementById('modal-title').textContent='ì¢…ëª© ìˆ˜ì • â€” '+h.name;
  document.getElementById('modal-submit-btn').textContent='ì €ì¥';
  document.getElementById('ai-fetch-area').style.display='none';
  setStatus('');
  document.getElementById('f-ticker').value   = h.ticker;
  document.getElementById('f-name').value     = h.name;
  document.getElementById('f-type').value     = h.type;
  document.getElementById('f-team').value     = h.team||'';
  document.getElementById('f-currency').value = h.currency;
  document.getElementById('f-buy').value      = h.buy;
  document.getElementById('f-current').value  = h.current;
  document.getElementById('f-qty').value      = h.qty;
  document.getElementById('f-dividend').value = h.dividend||'';
  document.getElementById('f-per').value      = h.per||'';
  document.getElementById('f-pbr').value      = h.pbr||'';
  document.getElementById('modal').classList.add('active');
}

function closeModal() {
  document.getElementById('modal').classList.remove('active');
  ['f-ticker','f-name','f-buy','f-current','f-qty','f-dividend','f-per','f-pbr','f-ticker-search']
    .forEach(id=>document.getElementById(id).value='');
  document.getElementById('f-team').value='';
  document.getElementById('f-type').value='êµ­ë‚´ì£¼ì‹';
  document.getElementById('f-currency').value='KRW';
  setStatus('');
}

function saveHolding() {
  const ticker  = document.getElementById('f-ticker').value.trim().toUpperCase();
  const name    = document.getElementById('f-name').value.trim();
  const buy     = parseFloat(document.getElementById('f-buy').value);
  const current = parseFloat(document.getElementById('f-current').value);
  const qty     = parseFloat(document.getElementById('f-qty').value);
  if (!ticker||!name||isNaN(buy)||isNaN(current)||isNaN(qty)) {
    alert('í‹°ì»¤, ì¢…ëª©ëª…, ë§¤ìˆ˜ê°€, í˜„ì¬ê°€, ìˆ˜ëŸ‰ì€ í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.'); return;
  }
  const h = {
    ticker, name,
    type:     document.getElementById('f-type').value,
    team:     document.getElementById('f-team').value,
    currency: document.getElementById('f-currency').value,
    buy, current, qty,
    dividend: parseFloat(document.getElementById('f-dividend').value)||0,
    per:      document.getElementById('f-per').value||'',
    pbr:      document.getElementById('f-pbr').value||'',
  };
  if (editingIndex>=0) holdings[editingIndex]=h;
  else holdings.push(h);
  closeModal(); render();
}

function deleteHolding(i) {
  if (!confirm(`'${holdings[i].name}'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  holdings.splice(i,1); render();
}

function clearAll() {
  if (!confirm('ëª¨ë“  ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  holdings=[]; render();
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initCharts();

const saved = loadData();
if (saved && saved.length > 0) {
  holdings = saved;
  render();
  refreshAllHoldings();
} else {
  // ìƒ˜í”Œ ë°ì´í„°
  holdings = [
    {ticker:'005930',name:'ì‚¼ì„±ì „ì',  type:'êµ­ë‚´ì£¼ì‹',team:'ì²­íŒ€',currency:'KRW',buy:72000, current:78500,qty:50,dividend:2.1,per:'14.2',pbr:'1.3'},
    {ticker:'AAPL',  name:'Apple',     type:'í•´ì™¸ì£¼ì‹',team:'ë°±íŒ€',currency:'USD',buy:175,   current:213,  qty:20,dividend:0.5,per:'32.1',pbr:'48.5'},
    {ticker:'KODEX200',name:'KODEX 200',type:'ETF',   team:'ì²­íŒ€',currency:'KRW',buy:35000, current:37200,qty:30,dividend:1.8,per:'12.0',pbr:'1.1'},
    {ticker:'QQQ',   name:'Invesco QQQ',type:'ETF',   team:'ë°±íŒ€',currency:'USD',buy:390,   current:485,  qty:10,dividend:0.6,per:'',    pbr:''},
    {ticker:'035720',name:'ì¹´ì¹´ì˜¤',    type:'êµ­ë‚´ì£¼ì‹',team:'',    currency:'KRW',buy:65000, current:41500,qty:20,dividend:0.3,per:'',    pbr:'1.9'},
  ];
  render();
}

document.getElementById('modal').addEventListener('click', e=>{
  if (e.target===document.getElementById('modal')) closeModal();
});
</script>
</body>
</html>
